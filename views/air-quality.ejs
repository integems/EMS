<!-- Wappler include head-page="layouts/portal_layout" is="dmx-app" id="airquality" appConnect="local" bootstrap5="local" fontawesome_6="local" bootstrap_icons="local" jquery_slim_35="cdn" components="{dmxBootstrap5Modal:{},dmxBootstrap5Navigation:{},dmxDatePicker:{}}" moment_2="cdn" -->
<meta name="ac:route" content="/air-quality">


<dmx-serverconnect id="sc_monitoring_location_type" url="/api/location/monitoring_location_type"></dmx-serverconnect>
<dmx-serverconnect id="sc_monitoring_location_id" url="/api/location/monitoring_location_id"></dmx-serverconnect>
<dmx-serverconnect id="sc_air_quality_date_time" url="/api/air_quality/date_time"></dmx-serverconnect>
<dmx-serverconnect id="sc_air_monitoring_locations"></dmx-serverconnect>

<div class="modal" id="modal_add_data" is="dmx-bs5-modal" tabindex="-1" nocloseonclick="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Monitoring Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <section id="input-file-browser">
                    <div class="row">
                        <form action="/api/test/database_multi_insert" method="post" is="dmx-serverconnect-form" id="sc_add_air_data" dmx-on:success="sc_add_air_data.reset();notifies1.success('Data successfully added.');modal_add_data.hide()">
                            <div class="col">
                                <div class="mb-3">
                                    <label for="data_file" class="form-label col-form-label">Monitoring Data</label>
                                    <input class="form-control" type="file" id="data_file" accept=".csv">
                                </div>

                            </div>
                            <div class="col">

                                <div>
                                    <label for="data_select" class="form-label col-form-label">Select Monitoring Location</label>
                                    <select id="data_select" class="form-select" name="location_id" dmx-bind:options="sc_monitoring_location_id.data.monitoring_location_id" optiontext="org_specific_monitoring_id" optionvalue="location_id">
                                        <option value="">Choose a Location</option>

                                    </select>
                                    <input id="inp_location_id" name="location_id" type="hidden" class="form-control" dmx-bind:value="data_select.selectedValue">
                                </div>
                            </div>
                        </form>
                    </div>
                </section>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" dmx-on:click="sc_add_air_data.submit()">Add Data</button>
            </div>
        </div>
    </div>
</div>


<div class="modal" id="modal_add_monitoring_location" is="dmx-bs5-modal" tabindex="-1" nocloseonclick="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Monitoring Location</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <section id="multiple-column-form">
                    <div class="row match-height">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-content">
                                    <div class="card-body">
                                        <form class="form" is="dmx-serverconnect-form" novalidate="" method="post" id="scf_add_monitoring_location" action="/api/location/add_monitoring_location" dmx-on:success="scf_add_monitoring_location.reset();modal_add_monitoring_location.hide()">
                                            <div class="row">
                                                <div class="col-md-6 col-12">
                                                    <div class="form-group">
                                                        <label for="latitude" class="col-form-label">Latitude</label>
                                                        <input type="number" id="latitude" class="form-control" placeholder="Latitude" name="latitude" is="dmx-input" value="">
                                                    </div>
                                                </div>
                                                <div class="col-md-6 col-12">
                                                    <div class="form-group">
                                                        <label for="longitude" class="col-form-label">Longitude</label>
                                                        <input type="number" id="longitude" class="form-control" placeholder="Longitude" name="longitude" is="dmx-input" value="">
                                                    </div>
                                                </div>
                                                <div class="col-md-6 col-12">
                                                    <div class="form-group">
                                                        <label for="monitoring_location_id" class="col-form-label">Monitoring Location ID</label>
                                                        <input id="text_monitoring_location" name="location_id" type="text" class="form-control">
                                                    </div>
                                                </div>
                                                <div class="col-md-6 col-12">
                                                    <div class="form-group">
                                                        <label for="country-floating" class="col-form-label">Location Type</label>
                                                        <select id="modal_select_location_type" class="form-select form-control" name="location_type" dmx-bind:options="sc_monitoring_location_type.data.location_type" optiontext="location_type" optionvalue="location_type_id">
                                                            <option value="">Select Location Types</option>

                                                        </select>

                                                    </div>
                                                </div>


                                            </div>
                                            <div class="row">
                                                <div class="col">
                                                    <div class="form-group">
                                                        <label for="company-column" class="col-form-label">Description</label>
                                                        <textarea id="text_location_description" class="form-control" name="location_description"></textarea>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col">
                                                    <div class="form-group">
                                                        <label for="company-column" class="col-form-label">Photos</label>
                                                        <input id="file_location_photos" name="path[]" type="file" class="form-control" multiple="true">
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" dmx-on:click="scf_add_monitoring_location.submit()">Add Location</button>
            </div>
        </div>
    </div>
</div>


<section>
    <div class="row text-end">

        <div class="col text-start">
            <h1 class="fw-normal fs-2">Air Quality Data Insights</h1>
            <div class="breadcrumb">
                <a class="breadcrumb-item breadcrumb-link fs-5 fw-light" href="/dashboard">Dashboard</a>
                <a class="breadcrumb-item breadcrumb-link fs-5 fw-bold" href="/air-quality">Air Quality</a>
            </div>
        </div>
        <div class="col text-end">
            <button id="btn_add_location" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modal_add_monitoring_location">Add Monitoring Location</button><button id="btn_add_noise_data" class="btn btn-primary ms-3" data-bs-toggle="modal" data-bs-target="#modal_add_data">Add Data</button>
        </div>
    </div>
</section>


<section class="mt-1 mb-3">
    <div class="row">
        <div class="col">
            <select id="select_location_id" class="form-select " name="location_id" dmx-bind:options="sc_monitoring_location_id.data.monitoring_location_id" optiontext="org_specific_monitoring_id" optionvalue="location_id">
                <option value="">All Location IDs</option>

            </select>


        </div>
        <div class="col"><select id="select_location_type" class="form-select " name="location_type" dmx-bind:options="sc_monitoring_location_type.data.location_type" optiontext="location_type" optionvalue="location_type_id">
                <option value="">All Location Types</option>

            </select></div>
        <div class="col"><input id="date_monitoring" name="date" is="dmx-date-range-picker" placeholder="Pick a Date Range" class="form-control "></div>
    </div>
</section>

<section class="mb-3">
    <div class="row">
        <div class="col-9">
            <div class="card ">
                <div class="card-body">
                    <h4 class="card-title mt-2">Monitoring Locations</h4>
                    <div id="location_map" style="height: 400px;"></div>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card ">
                <div class="card-body text-center">
                    <h5 class="card-title mt-2" id="cardTitle"></h5>
                    <img src="/assets/images/logo_icon.jpg" alt="Location Photos" width="118px" height="118px">
                    <p class="card-text" id="cardContent"></p>

                </div>
            </div>
        </div>
    </div>
</section>

<section class="mb-3">
    <div class="row">
        <div class="card">
            <div class="card-body">
                <div class="col" id="air_quality_chart" style="height: 400px;"></div>
            </div>
        </div>
    </div>
</section>


<!-- <section>
    <div class="row">
        <div class="col">
            <div id="parameterCarousel" class="carousel slide" data-ride="carousel">
                <div class="carousel-inner" style="height: 400px;"></div>
                <a class="carousel-control-prev" href="#parameterCarousel" role="button" data-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="sr-only">Previous</span>
                </a>
                <a class="carousel-control-next" href="#parameterCarousel" role="button" data-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="sr-only">Next</span>
                </a>
            </div>
        </div>
    </div>
</section> -->

<script>
    document.addEventListener("DOMContentLoaded", function() {
    // Fetch data from the server
    fetch('http://localhost:3000/api/air_quality/date_time')
        .then(response => response.json())
        .then(data => {
            // Check if 'date_time' property exists and is an array
            if (!data || !Array.isArray(data.date_time)) {
                console.error('Invalid data format. Expected an array under the "date_time" property.');
                return;
            }

            // Extract relevant data for the charts
            const airQualityData = data.date_time;

            // Sort the data by date_time in ascending order
            airQualityData.sort((a, b) => new Date(a.date_time) - new Date(b.date_time));

            // Prepare data series for each parameter
            const parameters = ['CO(ppm)', 'NO2(ppm)', 'PM10(ppm)', 'PM2_5(ppm)', 'RH(%)', 'SO2(ppm)', 'temp(C)'];

            // Create charts and add to the carousel
            parameters.forEach((parameter, index) => {
                const chartContainer = document.createElement('div');
                chartContainer.className = 'carousel-item' + (index === 0 ? ' active' : '');
                chartContainer.style.height = '100%';
                document.querySelector('.carousel-inner').appendChild(chartContainer);

                const seriesData = airQualityData.map(entry => ({
                    x: new Date(entry.date_time).getTime(),
                    y: entry[parameter]
                }));

                Highcharts.chart(chartContainer, {
                    chart: {
                        type: 'line'
                    },
                    title: {
                        text: `${parameter} Time Series Chart`
                    },
                    xAxis: {
                        type: 'datetime',
                        dateTimeLabelFormats: {
                            day: '%Y-%m-%d'
                        },
                        title: {
                            text: 'Date'
                        }
                    },
                    yAxis: {
                        title: {
                            text: 'Air Quality Values'
                        }
                    },
                    series: [{
                        name: parameter,
                        data: seriesData,
                        color: Highcharts.getOptions().colors[index]
                    }],
                    // Include accessibility module
                    accessibility: {
                        enabled: true
                    }
                });
            });

            // Initialize the Bootstrap carousel
            $('.carousel').carousel();
        })
        .catch(error => {
            console.error('Error fetching data:', error);
        });
});
</script>

<script src="/js/leaflet_maps/air_quality_monitoring_locations.js"></script>

<script src="/js/highcharts/highcharts_air_quality/air_quality_time_series.js" defer="true"></script>